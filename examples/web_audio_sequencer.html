<!DOCTYPE html>
<html>
	<html lang="en">
	<head>
		<title>three.js webaudio - audio sequencer</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link type="text/css" rel="stylesheet" href="main.css">
	</head>
	<body>

		<script type="module">

			import * as THREE from '../../build/three.module.js';
            import { AudioInstrument } from './jsm/audio/AudioInstrument.js'; 
            import { AudioGenerator } from './jsm/audio/AudioGenerator.js'; 
            import { AudioBuffer } from './jsm/audio/AudioBuffer.js'; 
            import { AudioSequencer } from './jsm/audio/AudioSequencer.js'; 
            import { AudioSequence } from './jsm/audio/AudioSequence.js'; 
            import { AudioFX } from './jsm/audio/AudioFX.js'; 
            import { AudioPlayer } from './jsm/audio/AudioPlayer.js'; 

            const listener = new THREE.AudioListener();

            // AUDIO

                // OCSILLATOR

                    // create a single cycle of a sine wave
                    const oscBuffer = new AudioBuffer( listener );
                    oscBuffer.createBuffer( 1 , 1 );
                    oscBuffer.sine( 1 , 1 ).fill( 0 );

                    // create an audio generator
                    const oscGenerator = new AudioGenerator( listener );
                    oscGenerator.loop = true;

                    // create a player for the generator
                    const oscPlayer = new AudioPlayer( oscGenerator );

                    // define a play method for the player
                    oscPlayer.play = function( startTime , stopTime , buffer , playbackRate ){

                        this.generator.playbackRate = playbackRate;
                        this.generator.buffer = buffer;
                        this.generator.start( startTime );
                        this.generator.stop( stopTime );

                    }
                
                // ENVELOPE

                    // create a buffer for an amplitude envelope
                    const envBuffer1 = new AudioBuffer( listener );
                    envBuffer1.createBuffer( 1 , 1 );
                    envBuffer1.ramp( 0 , 1 , 0.01 , 0.015 , 0.1 , 4 ).fill( 0 );

                    // create another buffer for a different amplitude envelope
                    const envBuffer2 = new AudioBuffer( listener );
                    envBuffer2.createBuffer( 1 , 1 );
                    envBuffer2.ramp( 0 , 1 , 0.5 , 0.5 , 1 , 1 ).fill( 0 );

                    // create a generator to output amplitude envelopes
                    const envGenerator = new AudioGenerator( listener );

                    // create a player to play the envelope generator
                    const envPlayer = new AudioPlayer( envGenerator );
                    
                    // define a play method for the envelope player
                    envPlayer.play = function( startTime , stopTime , buffer , playbackRate ){

                        this.generator.playbackRate = playbackRate;
                        this.generator.buffer = buffer;
                        this.generator.start( startTime );
                        this.generator.stop( stopTime );

                    }

                    // create a gain node to which the envelope will be applied
                    const envGain = listener.context.createGain();
                    envGain.gain.value = 0;

                // CONNECT NODES ( to be done in AudioSynth or AudioInstrument?)

                    oscGenerator.connect( envGain ); envGenerator.connect( envGain.gain );
                    envGain.connect( listener.getInput() );

                // ADD PLAYERS TO INSTRUMENT

                    const instrument = new AudioInstrument( listener );
                    instrument.addPlayer( oscPlayer );
                    instrument.addPlayer( envPlayer );

                // CREATE A SEQUENCER

                    const sequenceLength = 5;

                    const startSequence = new AudioSequence();
                    const stopSequence = new AudioSequence();
                    const oscBufferSequence = new AudioSequence();
                    const oscPlaybackRateSequence = new AudioSequence();
                    const envBufferSequence = new AudioSequence();
                    const envPlaybackRateSequence = new AudioSequence();

                    startSequence.duplicates( sequenceLength , 1 );
                    startSequence.sumSequence();

                    stopSequence.randomFloats( sequenceLength , 0.25 , 1 );
                    stopSequence.addSequence( startSequence.sequence );

                    oscBufferSequence.duplicates( sequenceLength , oscBuffer.buffer );
                    oscPlaybackRateSequence.randomMultiples( sequenceLength , 432 , [ 1 , 2 , 0.5 , 0.25 ]);

                    envBufferSequence.randomSelect( sequenceLength , [ envBuffer1.buffer , envBuffer2.buffer ] );
                    envPlaybackRateSequence.randomFloats( sequenceLength , 1 , 4 );

                    const mySequencer = new AudioSequencer();


                    const sequencer = [ 

                        [

                            [ 0 , 1 , oscBuffer.buffer , 432 ],
                            [ 1 , 2 , oscBuffer.buffer , 432 * 2 ],
                            [ 2 , 3 , oscBuffer.buffer , 432 * 0.25 ]
                            
                        ],

                        [

                            [ 0 , 1 , envBuffer1.buffer , 4 ],
                            [ 1 , 2 , envBuffer2.buffer , 1 ],
                            [ 2 , 3 , envBuffer1.buffer , 2 ]

                        ]

                    ]

                // PLAYBACK
    
                    // play the instrument
                    instrument.play( sequencer );

            // VISUAL

                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
                
                const geometry = new THREE.BoxGeometry();
                const material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
                const cube = new THREE.Mesh( geometry, material );
                scene.add( cube );

                camera.position.z = 5;

                const renderer = new THREE.WebGLRenderer();
                renderer.setSize( window.innerWidth, window.innerHeight );
                document.body.appendChild( renderer.domElement );
                
                function animate() {
                    
                    requestAnimationFrame( animate );


                    cube.rotation.x += 0.01;
                    cube.rotation.y += 0.01;

                    renderer.render( scene, camera );
                }
                animate();
		
        </script>
	</body>
</html>