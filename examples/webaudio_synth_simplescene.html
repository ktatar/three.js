<!DOCTYPE html>
<html>
	<html lang="en">
	<head>
		<title>three.js webaudio - synth simplescene</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link type="text/css" rel="stylesheet" href="main.css">
	</head>
	<body>

		<script type="module">

			import * as THREE from '../../build/three.module.js';
            import { AudioInstrument } from './jsm/audio/AudioInstrument.js'; 
            import { AudioGenerator } from './jsm/audio/AudioGenerator.js'; 
            import { AudioBuffer } from './jsm/audio/AudioBuffer.js'; 
            import { AudioFX } from './jsm/audio/AudioFX.js'; 

            const listener = new THREE.AudioListener();

            // AUDIO SYNTH
            const myInstrument = new AudioInstrument( listener );

            // AUDIO BUFFER
            const myBuffer = new AudioBuffer( listener );
            myBuffer.createBuffer( 1 , 1 );
            myBuffer.sawtooth( 1 ).add();

            // AUDIO GENERATOR
            const myGenerator = new AudioGenerator( listener );
            myGenerator.connect( listener.getInput() );

            myGenerator.playbackRate = 432;
            myGenerator.loop = true;
            myGenerator.setGain( 0.05 );
            
            myGenerator.start(  0 + myGenerator.context.currentTime , myBuffer.buffer );
            myGenerator.stop( 0.5 + myGenerator.context.currentTime );

            // Audio pipelines are fixed. 
            // Buffers are finalized after they are passed to a generator. 

            // AUDIO FX
            const myEffect = new AudioFX( listener );
            myEffect.delay( 0.25, 0.3 ).pan(-1).filter("lowpass", 1000, 1, 0).init();
            
            // Let's make a convolution reverb
            // First let's make a buffer to use as the impulse response of the reverb
            const convolverBuffer = new AudioBuffer( listener );
            convolverBuffer.createBuffer( 2 , 2 );
            convolverBuffer.noise().add();
            convolverBuffer.inverseSawtooth( 2 ).multiply();


            // Let's make another buffer to use as a distortion curve in a waveshaper
            const shaperBuffer = new AudioBuffer( listener );
            shaperBuffer.createBuffer( 1 , 1 );
            shaperBuffer.sigmoid( 10 ).add();

            // Let's add them to our sawtooth audio as an effect pipeline
            const myWaveShaper = new AudioFX( listener );
            myWaveShaper.waveShaper( shaperBuffer.buffer ).convolver( convolverBuffer.buffer ).pan(1).init();
            
            // AUDIO GENERATOR 2
            const myGenerator2 = new AudioGenerator( listener );
            myGenerator2.connect( listener.getInput() );

            myGenerator2.connect( myEffect.input );
            myEffect.connect( listener.getInput() );

            myGenerator2.connect( myWaveShaper.input );
            myWaveShaper.connect( listener.getInput() );

            myGenerator2.playbackRate = 432;
            myGenerator2.loop = true;
            myGenerator2.setGain( 0.05 );
            
            myGenerator2.start(  1 + myGenerator2.context.currentTime , myBuffer.buffer );
            myGenerator2.stop( 1.5 + myGenerator2.context.currentTime );

            // VISUAL STUFF
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
            
            const geometry = new THREE.BoxGeometry();
            const material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
            const cube = new THREE.Mesh( geometry, material );
            scene.add( cube );

            camera.position.z = 5;

            const renderer = new THREE.WebGLRenderer();
            renderer.setSize( window.innerWidth, window.innerHeight );
            document.body.appendChild( renderer.domElement );
            
            function animate() {
                
                requestAnimationFrame( animate );

                cube.rotation.x += 0.01;
                cube.rotation.y += 0.01;

                renderer.render( scene, camera );
            }
            animate();
		
        </script>
	</body>
</html>